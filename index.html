<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Sarabun', sans-serif;
        }
        
        .font-heading { font-family: 'Kanit', sans-serif; }
        
        #app {
            height: 100vh;
            width: 100vw;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
        
        .school-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        .school-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255,255,255,0.1) 0%, transparent 30%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .floating-delay {
            animation: floating 3s ease-in-out infinite;
            animation-delay: 1.5s;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(102, 126, 234, 0.5);
        }
        
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .input-field {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .badge-pending {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }
        
        .badge-approved {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .badge-rejected {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .decoration-circle {
            position: fixed;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            animation: pulse-slow 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .toast {
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .character {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .plant-left, .plant-right {
            position: fixed;
            bottom: 0;
            z-index: 10;
            pointer-events: none;
        }
        
        .plant-left { left: 0; }
        .plant-right { right: 0; }
        
        .bell-ring {
            animation: ring 0.5s ease;
        }
        
        @keyframes ring {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(10deg); }
        }
        
        .content-wrapper {
            position: relative;
            z-index: 20;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="school-bg"></div>
    
    <!-- Decorative Circles -->
    <div class="decoration-circle" style="width: 300px; height: 300px; top: -100px; left: -100px;"></div>
    <div class="decoration-circle" style="width: 200px; height: 200px; bottom: 100px; right: -50px; animation-delay: 2s;"></div>
    <div class="decoration-circle" style="width: 150px; height: 150px; top: 50%; left: 10%; animation-delay: 1s;"></div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Main App Container -->
    <div id="app" class="relative"></div>

    <!-- Plant Decorations -->
    <div class="plant-left floating" style="z-index: 5;">
        <svg width="120" height="150" viewBox="0 0 120 150" class="opacity-80">
            <ellipse cx="60" cy="140" rx="40" ry="10" fill="#4ade80" opacity="0.3"/>
            <path d="M60 140 Q55 100 30 80 Q50 90 60 70 Q70 90 90 80 Q65 100 60 140" fill="#22c55e"/>
            <path d="M60 70 Q50 50 35 45 Q55 55 60 30 Q65 55 85 45 Q70 50 60 70" fill="#4ade80"/>
            <circle cx="60" cy="25" r="8" fill="#fbbf24"/>
            <circle cx="58" cy="23" r="2" fill="#92400e"/>
            <circle cx="62" cy="23" r="2" fill="#92400e"/>
            <path d="M56 28 Q60 32 64 28" stroke="#92400e" fill="none" stroke-width="1.5"/>
        </svg>
    </div>
    
    <div class="plant-right floating-delay" style="z-index: 5;">
        <svg width="120" height="150" viewBox="0 0 120 150" class="opacity-80">
            <ellipse cx="60" cy="140" rx="40" ry="10" fill="#f472b6" opacity="0.3"/>
            <path d="M60 140 Q55 110 40 95 Q55 100 60 80 Q65 100 80 95 Q65 110 60 140" fill="#ec4899"/>
            <path d="M60 80 Q45 65 35 60 Q50 65 60 45 Q70 65 85 60 Q75 65 60 80" fill="#f472b6"/>
            <circle cx="60" cy="40" r="10" fill="#fbbf24"/>
            <circle cx="57" cy="38" r="2" fill="#92400e"/>
            <circle cx="63" cy="38" r="2" fill="#92400e"/>
            <path d="M55 43 Q60 47 65 43" stroke="#92400e" fill="none" stroke-width="1.5"/>
        </svg>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <img id="imageModalImg" src="" class="max-w-full max-h-full rounded-2xl shadow-2xl" alt="‡∏£‡∏π‡∏õ‡∏Ç‡∏¢‡∏≤‡∏¢">
    </div>

    <script>
        // ==================== Firebase Configuration ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCm9QsD6NwRF0zusMzgESEyA43hjEyHRhw",
            authDomain: "sw-website-68.firebaseapp.com",
            databaseURL: "https://sw-website-68-default-rtdb.firebaseio.com",
            projectId: "sw-website-68",
            storageBucket: "sw-website-68.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "1:YOUR_APP_ID:web:28d2f983c552a118e9397c",
            measurementId: "G-ESPPG76N3H"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ==================== App State ====================
        const state = {
            currentPage: 'login',
            userType: null,
            studentId: null,
            studentName: null,
            requests: [],
            studentRequests: [],
            filterStatus: 'all',
            unsubscribe: null,
            schoolName: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç',
            currentRejectionId: null
        };
        
        const TEACHER_CREDENTIALS = {
            username: 'teacher',
            password: '1234'
        };
        
        // ==================== Utility Functions ====================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            
            toast.className = `toast ${bgColor} text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `<span class="text-xl">${icon}</span><span class="font-medium">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function formatDate(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        async function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // ==================== Firebase Functions ====================
        async function submitLeaveRequest(data) {
            try {
                const docRef = await db.collection('leave_requests').add({
                    ...data,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    teacherNote: ''
                });
                return { success: true, id: docRef.id };
            } catch (error) {
                console.error('Error submitting request:', error);
                return { success: false, error };
            }
        }
        
        async function updateRequestStatus(requestId, status, note = '') {
            try {
                await db.collection('leave_requests').doc(requestId).update({
                    status: status,
                    teacherNote: note,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return { success: true };
            } catch (error) {
                console.error('Error updating request:', error);
                return { success: false, error };
            }
        }
        
        function subscribeToRequests(callback, studentId = null) {
            let query = db.collection('leave_requests').orderBy('createdAt', 'desc');
            
            if (studentId) {
                query = query.where('studentId', '==', studentId);
            }
            
            return query.onSnapshot((snapshot) => {
                const requests = [];
                snapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                callback(requests);
            }, (error) => {
                console.error('Error listening to requests:', error);
            });
        }
        
        // ==================== Render Functions ====================
        function render() {
            const app = document.getElementById('app');
            let html = '';
            
            switch (state.currentPage) {
                case 'login':
                    html = renderLoginPage();
                    break;
                case 'student-dashboard':
                    html = renderStudentDashboard();
                    break;
                case 'teacher-dashboard':
                    html = renderTeacherDashboard();
                    break;
            }
            
            app.innerHTML = `<div class="content-wrapper">${html}</div>`;
            
            if (state.currentPage === 'student-dashboard') {
                setupStudentListeners();
            } else if (state.currentPage === 'teacher-dashboard') {
                setupTeacherListeners();
            }
        }
        
        function renderLoginPage() {
            return `
                <div class="min-h-screen flex items-center justify-center py-12">
                    <div class="glass-card rounded-3xl p-8 w-full max-w-md">
                        <div class="text-center relative z-10 mb-8">
                            <div class="floating inline-block mb-4">
                                <svg width="100" height="100" viewBox="0 0 100 100" class="character">
                                    <circle cx="50" cy="45" r="35" fill="#fbbf24"/>
                                    <circle cx="50" cy="45" r="32" fill="#fcd34d"/>
                                    <ellipse cx="38" cy="42" rx="6" ry="8" fill="white"/>
                                    <ellipse cx="62" cy="42" rx="6" ry="8" fill="white"/>
                                    <circle cx="40" cy="43" r="3" fill="#1f2937"/>
                                    <circle cx="64" cy="43" r="3" fill="#1f2937"/>
                                    <circle cx="41" cy="42" r="1" fill="white"/>
                                    <circle cx="65" cy="42" r="1" fill="white"/>
                                    <ellipse cx="28" cy="52" rx="6" ry="4" fill="#fca5a5" opacity="0.6"/>
                                    <ellipse cx="72" cy="52" rx="6" ry="4" fill="#fca5a5" opacity="0.6"/>
                                    <path d="M 40 55 Q 50 65 60 55" stroke="#92400e" stroke-width="3" fill="none" stroke-linecap="round"/>
                                    <rect x="25" y="15" width="50" height="8" fill="#1f2937" rx="2"/>
                                    <rect x="35" y="8" width="30" height="10" fill="#1f2937"/>
                                    <circle cx="50" cy="10" r="4" fill="#fbbf24"/>
                                    <line x1="50" y1="10" x2="50" y2="5" stroke="#fbbf24" stroke-width="2"/>
                                    <circle cx="50" cy="3" r="3" fill="#fbbf24"/>
                                </svg>
                            </div>
                            <h1 class="font-heading text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                ${state.schoolName}
                            </h1>
                            <p class="text-gray-500 mt-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô</p>
                        </div>
                        
                        <div class="flex bg-gray-100 rounded-2xl p-1 mb-6">
                            <button onclick="switchLoginType('student')" id="tabStudent" 
                                class="flex-1 py-3 rounded-xl font-medium transition-all duration-300 tab-active">
                                üéí ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                            <button onclick="switchLoginType('teacher')" id="tabTeacher"
                                class="flex-1 py-3 rounded-xl font-medium transition-all duration-300 text-gray-600">
                                üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£
                            </button>
                        </div>
                        
                        <div id="studentLoginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üî¢ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentIdInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ü™™ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢</label>
                                <input type="password" id="studentIdCardInput" placeholder="xxxx" maxlength="4"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üë§ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input type="text" id="studentNameInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            <button onclick="loginStudent()" 
                                class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg mt-6">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                        
                        <div id="teacherLoginForm" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                                <input type="text" id="teacherUsernameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="teacherPasswordInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            <button onclick="loginTeacher()" 
                                class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg mt-6">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                            <p class="text-center text-sm text-gray-500 mt-4">üí° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderStudentDashboard() {
            return `
                <div class="max-w-4xl mx-auto pb-20">
                    <div class="glass-card rounded-3xl p-6 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-white text-2xl floating">
                                    üéí
                                </div>
                                <div>
                                    <h2 class="font-heading text-xl font-bold text-gray-800">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${state.studentName}</h2>
                                    <p class="text-gray-500">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${state.studentId}</p>
                                </div>
                            </div>
                            <button onclick="logout()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-gray-600 transition-all">
                                üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-6 mb-6">
                        <h3 class="font-heading text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <span class="text-2xl">üìù</span> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô
                        </h3>
                        
                        <form id="leaveForm" class="space-y-5">
                            <div class="grid md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</label>
                                    <input type="date" id="leaveDate" 
                                        class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å</label>
                                    <input type="time" id="leaveTime" 
                                        class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                                <input type="time" id="returnTime" placeholder="‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìã ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                                <textarea id="leaveReason" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô..."
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50 resize-none"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üë®‚Äçüë©‚Äçüëß ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö</label>
                                <input type="text" id="parentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                                <input type="tel" id="parentPhone" placeholder="0xx-xxx-xxxx"
                                    class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üì∏ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á (‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                                <div class="relative">
                                    <input type="file" id="parentPhoto" accept="image/*" capture="environment"
                                        class="hidden" onchange="handlePhotoUpload(event)">
                                    <div id="photoPreview" onclick="document.getElementById('parentPhoto').click()"
                                        class="input-field w-full h-48 rounded-xl bg-gray-50 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 transition-all overflow-hidden">
                                        <div class="text-5xl mb-2">üì∑</div>
                                        <p class="text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</p>
                                        <p class="text-xs text-gray-400 mt-1">‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" id="submitBtn"
                                class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg flex items-center justify-center gap-2">
                                <span>üì§</span> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
                            </button>
                        </form>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-6 mb-20">
                        <h3 class="font-heading text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <span class="text-2xl">üìö</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏•‡∏≤
                        </h3>
                        
                        <div id="studentRequestList" class="space-y-4">
                            ${renderStudentRequests()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderStudentRequests() {
            if (state.studentRequests.length === 0) {
                return `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üì≠</div>
                        <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏•‡∏≤</p>
                    </div>
                `;
            }
            
            return state.studentRequests.map(req => `
                <div class="bg-gradient-to-r from-gray-50 to-white p-5 rounded-2xl border border-gray-100 hover:shadow-lg transition-all">
                    <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
                        <div>
                            <p class="font-medium text-gray-800">${formatDate(req.createdAt)}</p>
                            <p class="text-sm text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: ${req.leaveTime || '-'} ${req.returnTime ? `| ‡∏Å‡∏•‡∏±‡∏ö: ${req.returnTime}` : ''}</p>
                        </div>
                        <span class="px-4 py-1.5 rounded-full text-white text-sm font-medium ${
                            req.status === 'pending' ? 'badge-pending' :
                            req.status === 'approved' ? 'badge-approved' : 'badge-rejected'
                        }">
                            ${req.status === 'pending' ? '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' :
                              req.status === 'approved' ? '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                        </span>
                    </div>
                    <p class="text-gray-600 mb-2"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${req.reason}</p>
                    <p class="text-gray-600"><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á:</strong> ${req.parentName} (${req.parentPhone})</p>
                    ${req.status === 'rejected' && req.teacherNote ? `
                        <div class="mt-3 p-3 bg-red-50 rounded-xl border border-red-100">
                            <p class="text-red-600 text-sm"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π:</strong> ${req.teacherNote}</p>
                        </div>
                    ` : ''}
                    ${req.parentPhotoUrl ? `
                        <div class="mt-3">
                            <img src="${req.parentPhotoUrl}" alt="‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á" class="w-32 h-32 object-cover rounded-xl cursor-pointer hover:opacity-80 transition-all"
                                onclick="openImageModal('${req.parentPhotoUrl}')">
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function renderTeacherDashboard() {
            const filteredRequests = state.filterStatus === 'all' 
                ? state.requests 
                : state.requests.filter(r => r.status === state.filterStatus);
            
            const pendingCount = state.requests.filter(r => r.status === 'pending').length;
            
            return `
                <div class="max-w-6xl mx-auto pb-20">
                    <div class="glass-card rounded-3xl p-6 mb-6 sticky top-0 z-30">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-teal-500 rounded-2xl flex items-center justify-center text-white text-2xl floating">
                                    üë®‚Äçüè´
                                </div>
                                <div>
                                    <h2 class="font-heading text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô - ‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h2>
                                    <p class="text-gray-500">${state.schoolName}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${pendingCount > 0 ? `
                                    <div class="px-4 py-2 bg-orange-100 text-orange-600 rounded-xl flex items-center gap-2">
                                        <span class="bell-ring">üîî</span>
                                        <span class="font-medium">${pendingCount} ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                                    </div>
                                ` : ''}
                                <button onclick="logout()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-gray-600 transition-all">
                                    üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-card rounded-2xl p-5 text-center">
                            <div class="text-3xl mb-2">üìä</div>
                            <p class="text-2xl font-bold text-gray-800">${state.requests.length}</p>
                            <p class="text-gray-500 text-sm">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        </div>
                        <div class="glass-card rounded-2xl p-5 text-center">
                            <div class="text-3xl mb-2">‚è≥</div>
                            <p class="text-2xl font-bold text-orange-500">${state.requests.filter(r => r.status === 'pending').length}</p>
                            <p class="text-gray-500 text-sm">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                        </div>
                        <div class="glass-card rounded-2xl p-5 text-center">
                            <div class="text-3xl mb-2">‚úÖ</div>
                            <p class="text-2xl font-bold text-green-500">${state.requests.filter(r => r.status === 'approved').length}</p>
                            <p class="text-gray-500 text-sm">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                        <div class="glass-card rounded-2xl p-5 text-center">
                            <div class="text-3xl mb-2">‚ùå</div>
                            <p class="text-2xl font-bold text-red-500">${state.requests.filter(r => r.status === 'rejected').length}</p>
                            <p class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-6 mb-20">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <h3 class="font-heading text-xl font-bold text-gray-800 flex items-center gap-2">
                                <span class="text-2xl">üìã</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
                            </h3>
                            <div class="flex bg-gray-100 rounded-xl p-1 overflow-x-auto">
                                <button onclick="setFilter('all')" 
                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${state.filterStatus === 'all' ? 'bg-white shadow text-purple-600' : 'text-gray-600'}">
                                    ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                                <button onclick="setFilter('pending')" 
                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${state.filterStatus === 'pending' ? 'bg-white shadow text-orange-600' : 'text-gray-600'}">
                                    ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                                </button>
                                <button onclick="setFilter('approved')" 
                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${state.filterStatus === 'approved' ? 'bg-white shadow text-green-600' : 'text-gray-600'}">
                                    ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                                </button>
                                <button onclick="setFilter('rejected')" 
                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${state.filterStatus === 'rejected' ? 'bg-white shadow text-red-600' : 'text-gray-600'}">
                                    ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                            </div>
                        </div>
                        
                        <div id="requestList" class="space-y-4">
                            ${renderTeacherRequests(filteredRequests)}
                        </div>
                    </div>
                </div>
                
                <div id="rejectionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
                    <div class="glass-card rounded-3xl p-6 w-full max-w-md">
                        <h4 class="font-heading text-xl font-bold text-gray-800 mb-4">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</h4>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</label>
                            <textarea id="rejectionNote" rows="3" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."
                                class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50 resize-none"></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeRejectionModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-all">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button onclick="confirmRejection()" class="flex-1 py-3 btn-danger rounded-xl text-white font-medium">
                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderTeacherRequests(requests) {
            if (requests.length === 0) {
                return `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üì≠</div>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>
                    </div>
                `;
            }
            
            return requests.map(req => `
                <div class="bg-gradient-to-r from-gray-50 to-white p-5 rounded-2xl border border-gray-100 hover:shadow-lg transition-all">
                    <div class="flex flex-wrap gap-4">
                        ${req.parentPhotoUrl ? `
                            <div class="w-24 h-24 rounded-xl overflow-hidden flex-shrink-0">
                                <img src="${req.parentPhotoUrl}" alt="‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á" class="w-full h-full object-cover cursor-pointer hover:scale-110 transition-transform"
                                    onclick="openImageModal('${req.parentPhotoUrl}')">
                            </div>
                        ` : `
                            <div class="w-24 h-24 rounded-xl bg-gray-200 flex items-center justify-center flex-shrink-0">
                                <span class="text-3xl">üë§</span>
                            </div>
                        `}
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-start justify-between gap-2 mb-2">
                                <div>
                                    <h4 class="font-heading font-bold text-lg text-gray-800">${req.studentName}</h4>
                                    <p class="text-sm text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${req.studentId} | ${formatDate(req.createdAt)}</p>
                                </div>
                                <span class="px-4 py-1.5 rounded-full text-white text-sm font-medium ${
                                    req.status === 'pending' ? 'badge-pending' :
                                    req.status === 'approved' ? 'badge-approved' : 'badge-rejected'
                                }">
                                    ${req.status === 'pending' ? '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' :
                                      req.status === 'approved' ? '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                                </span>
                            </div>
                            
                            <div class="grid sm:grid-cols-2 gap-2 text-sm mb-3">
                                <p><span class="text-gray-500">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤:</span> ${req.leaveDate}</p>
                                <p><span class="text-gray-500">üïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</span> ${req.leaveTime}</p>
                                <p><span class="text-gray-500">üïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö:</span> ${req.returnTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                                <p><span class="text-gray-500">üë®‚Äçüë©‚Äçüëß ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á:</span> ${req.parentName}</p>
                                <p class="sm:col-span-2"><span class="text-gray-500">üì± ‡πÇ‡∏ó‡∏£:</span> ${req.parentPhone}</p>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded-xl mb-3">
                                <p class="text-gray-600"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${req.reason}</p>
                            </div>
                            
                            ${req.status === 'rejected' && req.teacherNote ? `
                                <div class="bg-red-50 p-3 rounded-xl border border-red-100 mb-3">
                                    <p class="text-red-600 text-sm"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${req.teacherNote}</p>
                                </div>
                            ` : ''}
                            
                            ${req.status === 'pending' ? `
                                <div class="flex gap-3">
                                    <button onclick="approveRequest('${req.id}')" 
                                        class="flex-1 py-2.5 btn-success rounded-xl text-white font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all">
                                        <span>‚úÖ</span> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </button>
                                    <button onclick="openRejectionModal('${req.id}')" 
                                        class="flex-1 py-2.5 btn-danger rounded-xl text-white font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all">
                                        <span>‚ùå</span> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ==================== Event Handlers ====================
        function switchLoginType(type) {
            const studentForm = document.getElementById('studentLoginForm');
            const teacherForm = document.getElementById('teacherLoginForm');
            const tabStudent = document.getElementById('tabStudent');
            const tabTeacher = document.getElementById('tabTeacher');
            
            if (type === 'student') {
                studentForm.classList.remove('hidden');
                teacherForm.classList.add('hidden');
                tabStudent.classList.add('tab-active');
                tabTeacher.classList.remove('tab-active');
                tabTeacher.classList.add('text-gray-600');
            } else {
                studentForm.classList.add('hidden');
                teacherForm.classList.remove('hidden');
                tabTeacher.classList.add('tab-active');
                tabStudent.classList.remove('tab-active');
                tabStudent.classList.add('text-gray-600');
            }
        }
        
        function loginStudent() {
            const studentId = document.getElementById('studentIdInput').value.trim();
            const idCard = document.getElementById('studentIdCardInput').value.trim();
            const name = document.getElementById('studentNameInput').value.trim();
            
            if (!studentId || !idCard || !name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            if (idCard.length !== 4) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢', 'error');
                return;
            }
            
            state.userType = 'student';
            state.studentId = studentId;
            state.studentName = name;
            state.currentPage = 'student-dashboard';
            
            if (state.unsubscribe) state.unsubscribe();
            state.unsubscribe = subscribeToRequests((requests) => {
                state.studentRequests = requests;
                const listEl = document.getElementById('studentRequestList');
                if (listEl) {
                    listEl.innerHTML = renderStudentRequests();
                }
            }, studentId);
            
            showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            render();
        }
        
        function loginTeacher() {
            const username = document.getElementById('teacherUsernameInput').value.trim();
            const password = document.getElementById('teacherPasswordInput').value.trim();
            
            if (username === TEACHER_CREDENTIALS.username && password === TEACHER_CREDENTIALS.password) {
                state.userType = 'teacher';
                state.currentPage = 'teacher-dashboard';
                
                if (state.unsubscribe) state.unsubscribe();
                state.unsubscribe = subscribeToRequests((requests) => {
                    const previousPending = state.requests.filter(r => r.status === 'pending').length;
                    state.requests = requests;
                    const currentPending = requests.filter(r => r.status === 'pending').length;
                    
                    if (currentPending > previousPending) {
                        showToast('üîî ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!', 'info');
                    }
                    
                    render();
                });
                
                showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                render();
            } else {
                showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        }
        
        function logout() {
            if (state.unsubscribe) {
                state.unsubscribe();
                state.unsubscribe = null;
            }
            
            state.currentPage = 'login';
            state.userType = null;
            state.studentId = null;
            state.studentName = null;
            state.requests = [];
            state.studentRequests = [];
            
            showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            render();
        }
        
        let currentPhotoData = null;
        
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="spinner border-purple-500 border-t-white mb-2"></div>
                    <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ...</p>
                </div>
            `;
            
            try {
                currentPhotoData = await compressImage(file);
                preview.innerHTML = `<img src="${currentPhotoData}" class="w-full h-full object-cover" alt="‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">`;
                showToast('‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                preview.innerHTML = `
                    <div class="text-5xl mb-2">üì∑</div>
                    <p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</p>
                `;
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ', 'error');
            }
        }
        
        function setupStudentListeners() {
            const form = document.getElementById('leaveForm');
            if (!form) return;
            
            const dateInput = document.getElementById('leaveDate');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const leaveDate = document.getElementById('leaveDate').value;
                const leaveTime = document.getElementById('leaveTime').value;
                const returnTime = document.getElementById('returnTime').value;
                const reason = document.getElementById('leaveReason').value.trim();
                const parentName = document.getElementById('parentName').value.trim();
                const parentPhone = document.getElementById('parentPhone').value.trim();
                
                if (!leaveDate || !leaveTime || !reason || !parentName || !parentPhone) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('submitBtn');
           
